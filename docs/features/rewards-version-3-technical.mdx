# SEND Rewards: Technical Specification

This document provides a technical reference for the SEND distribution system (V2), covering qualification logic, pool calculations, and the send score mechanism.

---

## System Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          DISTRIBUTION FLOW                                │
│                                                                           │
│  ┌─────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────┐ │
│  │   Hourly    │───▶│  Fetch       │───▶│  Calculate   │───▶│  Store   │ │
│  │   Trigger   │    │  Snapshots   │    │  Shares      │    │  Shares  │ │
│  └─────────────┘    └──────────────┘    └──────────────┘    └──────────┘ │
│                            │                   │                          │
│                            ▼                   ▼                          │
│                     ┌─────────────────────────────────────┐               │
│                     │  Data Sources:                      │               │
│                     │  • distribution_verifications       │               │
│                     │  • send_accounts + balances         │               │
│                     │  • send_earn_balances_timeline      │               │
│                     │  • send_scores (view)               │               │
│                     │  • previous distribution_shares     │               │
│                     └─────────────────────────────────────┘               │
└──────────────────────────────────────────────────────────────────────────┘
```

Source: `apps/distributor/src/distributorv2.ts`

---

## Qualification Criteria

A user qualifies when all three conditions are met at snapshot:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      QUALIFICATION CHECK                                 │
│                                                                          │
│  qualifyingUserIds = minBalanceAddresses.filter(({ address, user_id })  │
│    =>                                                                    │
│      minEarnBalancesByAddress[address]           // earn_min_balance     │
│      && hodlerUserIdByAddress[address]           // valid send_account   │
│      && verificationsByUserId[user_id].some(                            │
│           v => v.type === 'tag_registration' && v.weight > 0            │
│         )                                        // sendtag verified     │
│  )                                                                       │
│                                                                          │
│  Parameters (from distributions table):                                  │
│  • hodler_min_balance: minimum SEND token balance                       │
│  • earn_min_balance: minimum Send Earn USDC balance                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Send Score Calculation

### SQL Implementation

The send ceiling and score are computed in `supabase/schemas/send_scores.sql`:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SEND CEILING FORMULA                                  │
│                                                                          │
│  send_ceiling = ROUND(                                                   │
│    COALESCE(                                                            │
│      previous_distribution_share,                                        │
│      hodler_min_balance                                                  │
│    ) / (minimum_sends * scaling_divisor)                                │
│  )                                                                       │
│                                                                          │
│  Source: send_slash table provides minimum_sends, scaling_divisor        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Score Aggregation

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SCORE CALCULATION                                     │
│                                                                          │
│  score = SUM(                                                            │
│    LEAST(transfer_sum_per_recipient, send_ceiling)                       │
│  )                                                                       │
│                                                                          │
│  WHERE:                                                                  │
│  • transfer includes: send_token_transfers + send_token_v0_transfers     │
│                       + send_check_claimed (SEND token, redeemer≠sender) │
│  • recipient must have earn_min_balance in send_earn_balances_timeline   │
│  • block_time within qualification_start..qualification_end              │
│                                                                          │
│  unique_sends = COUNT(DISTINCT recipient)                                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Pool Allocation Algorithm

### V2 Changes from V1

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    V2 KEY DIFFERENCES                                    │
│                                                                          │
│  • Fixed pool calculated FIRST from total distribution amount            │
│  • Hodler pool = distAmt - fixedPoolAllocatedAmount                      │
│  • bonus_pool_amount ALWAYS set to 0                                     │
│  • No holder_bips or bonus_bips calculations                             │
│  • Send slash system: non-senders get 0 rewards                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Fixed Pool Calculation

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    FIXED POOL ALGORITHM                                  │
│                                                                          │
│  FOR each qualifying user:                                               │
│                                                                          │
│    1. Sum fixed_value * weight for each verification                     │
│                                                                          │
│    2. Calculate multipliers:                                             │
│       - Initial: multiplier_min                                          │
│       - Per completion: += multiplier_step (capped at multiplier_max)    │
│       - Final: product of all applicable multipliers                     │
│                                                                          │
│    3. Apply multiplier: userFixedAmount * finalMultiplier                │
│                                                                          │
│    4. Apply slash:                                                       │
│       scaled_prev = previousReward / scaling_divisor                     │
│       capped = min(sendCeilingWeight, scaled_prev)                       │
│       slashPct = capped / scaled_prev                                    │
│       amount *= slashPct                                                 │
│       (if sendCeilingWeight = 0, amount = 0)                             │
│                                                                          │
│    5. Apply cap:                                                         │
│       amount = min(amount, hodlerAmt + sendScore + ticketValue)          │
│                                                                          │
│  fixedPoolAllocatedAmount = Σ(user amounts)                              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Hodler Pool Calculation

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    HODLER POOL ALGORITHM                                 │
│                                                                          │
│  hodlerPoolAvailableAmount = distAmt - fixedPoolAllocatedAmount          │
│                                                                          │
│  IF hodlerPoolAvailableAmount > 0:                                       │
│                                                                          │
│    1. Time adjustment (hourly accrual):                                  │
│       hourlyAmount = hodlerPool / hoursInMonth                           │
│       timeAdjusted = min(hourlyAmount * (currentHour+1), hodlerPool)     │
│                                                                          │
│    2. Calculate slashed balances for each user:                          │
│       slashPct = (capped_send_weight / scaled_prev_reward)               │
│       slashedBalance = balance * slashPct                                │
│                                                                          │
│    3. Distribute via sigmoid weighting:                                  │
│       calculateWeights(slashedBalances, timeAdjusted, Mode.Sigmoid)      │
│                                                                          │
│  Final share = hodlerPoolAmount + fixedPoolAmount                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Verification Types

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    VERIFICATION TYPES                                    │
│                                                                          │
│  Type                      │ fixed_value │ multiplier │ Notes            │
│  ─────────────────────────────────────────────────────────────────────  │
│  tag_registration          │    Yes      │    No      │ Required         │
│  create_passkey            │    Yes      │    No      │ Task             │
│  send_ten                  │    Yes      │    No      │ Task             │
│  send_one_hundred          │    Yes      │    No      │ Task             │
│  send_streak               │    Yes      │    No      │ Daily task       │
│  sendpot_ticket_purchase   │    Yes      │    No      │ metadata.value   │
│  tag_referral              │    Yes      │    Yes     │ Per-dist mult    │
│  total_tag_referrals       │    Yes      │    Yes     │ Cumulative       │
│  send_ceiling              │    No       │    No      │ Weight = score   │
│                                                                          │
│  Source: distribution_verification_values table                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## UI Progress Calculation

From `packages/app/features/rewards/activity/screen.tsx`:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PROGRESS BAR LOGIC                                    │
│                                                                          │
│  previousReward = distribution_shares[prev].amount                       │
│                   || hodler_min_balance                                  │
│                                                                          │
│  scaledPreviousReward = previousReward / scaling_divisor                 │
│                                                                          │
│  sendCeilingWeight = verification.weight WHERE type='send_ceiling'       │
│                                                                          │
│  progress = (                                                            │
│    min(sendCeilingWeight, scaledPreviousReward) * 10000n                 │
│    / scaledPreviousReward                                                │
│  ) / 100                                                                 │
│                                                                          │
│  Display: progress.toFixed(1) + '%'                                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**Note:** Progress represents send_ceiling_weight / scaled_previous_reward, not raw SEND transferred.

---

## Key Invariants

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SYSTEM INVARIANTS                                     │
│                                                                          │
│  1. totalShareAmounts ≤ distAmt                                         │
│     (enforced: throws if exceeded)                                       │
│                                                                          │
│  2. bonus_pool_amount = 0 for all shares                                │
│     (hardcoded in V2)                                                    │
│                                                                          │
│  3. sendCeilingWeight = 0 → slashPercentage = 0                         │
│     → fixedPoolAmount = 0 AND hodlerPoolAmount = 0                       │
│                                                                          │
│  4. Recipient without earn_min_balance → transfer not counted            │
│                                                                          │
│  5. Verifications/multipliers per-distribution only                     │
│     (no cross-month accumulation)                                        │
│                                                                          │
│  6. Fixed reward capped by: initialHodlerAmt + sendScore + ticketValue  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Database Schema References

| Table/View | Purpose |
|------------|---------|
| `distributions` | Distribution parameters (dates, amounts, min balances) |
| `distribution_verifications` | User verification records per distribution |
| `distribution_verification_values` | Task fixed_value, multiplier config |
| `distribution_shares` | Calculated user shares |
| `send_slash` | minimum_sends, scaling_divisor per distribution |
| `send_scores` (view) | Unified current + historical send scores |
| `send_scores_current` (view) | Real-time score calculation |
| `send_scores_history` (mat view) | Historical scores (refreshed) |
| `send_accounts` | User addresses linked to user_id |
| `send_earn_balances_timeline` | Earn balance snapshots |
| `send_token_transfers` | SEND token transfer events |

---

## API Endpoints

| Endpoint | Returns |
|----------|---------|
| `get_send_score(addr)` | (distribution_id, score, unique_sends, send_ceiling) |
| `get_send_scores_history()` | Historical scores (auth-scoped) |

---

## Error Conditions

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ERROR HANDLING                                        │
│                                                                          │
│  Condition                        │ Behavior                             │
│  ────────────────────────────────────────────────────────────────────── │
│  Tranche active                   │ Throws, no recalculation             │
│  No verifications                 │ Skip distribution                    │
│  No earn balances                 │ Return early                         │
│  No previous shares               │ Uses hodler_min_balance              │
│  No send scores                   │ Throws                               │
│  Share amounts > distAmt          │ Throws                               │
│  Share missing amount             │ Throws                               │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Code References

- Distribution calculation: `apps/distributor/src/distributorv2.ts`
- Send score SQL: `supabase/schemas/send_scores.sql`
- Send score views: `supabase/schemas/views/send_scores.sql`
- Activity UI: `packages/app/features/rewards/activity/screen.tsx`
- Distribution hooks: `packages/app/utils/distributions.ts`
