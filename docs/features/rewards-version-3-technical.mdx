# Send Rewards Technical Specification

This document provides technical implementation details for the Send rewards distribution system, covering database schemas, calculation logic, and referral verification mechanisms.

## Architecture Overview

The rewards system consists of three main components:

1. **Supabase Database** - Stores distributions, verifications, and shares
2. **Distributor V2 Worker** - Calculates distribution shares (`apps/distributor/src/distributorv2.ts`)
3. **Frontend UI** - Displays verification status and claim interface

## Database Schema

### Core Tables

```sql
-- Distribution configuration
distributions (
  id, number, amount, qualification_start, qualification_end,
  hodler_min_balance, earn_min_balance, merkle_drop_addr, tranche_id
)

-- Verification values per distribution
distribution_verification_values (
  type verification_type,
  fixed_value numeric,
  bips_value bigint,
  multiplier_min numeric(10,4),
  multiplier_max numeric(10,4),
  multiplier_step numeric(10,4),
  distribution_id integer
)

-- User verifications
distribution_verifications (
  distribution_id, user_id, type verification_type,
  weight numeric DEFAULT 1, metadata jsonb
)

-- Final calculated shares
distribution_shares (
  distribution_id, user_id, address, amount,
  hodler_pool_amount, bonus_pool_amount, fixed_pool_amount
)
```

### Referral Tables

```sql
-- Referral relationships
referrals (
  referrer_id uuid,
  referred_id uuid,
  tag text,
  created_at timestamp
)
```

## Referral Marketing Implementation

### Verification Types

Two verification types handle referral rewards:

| Type | Purpose | Values (Distribution 14+) |
|------|---------|---------------------------|
| `tag_referral` | Monthly referrals in current distribution | min=1.1, max=2.0, step=0.1 |
| `total_tag_referrals` | Cumulative lifetime referrals | min=1.02, max=2.0, step=0.02 |

### Referral Qualification Logic

Referrals are qualified based on the referred user's participation in the **previous** distribution. The canonical implementation is in `update_referral_verifications`:

```sql
-- From supabase/schemas/distributions.sql
CREATE OR REPLACE FUNCTION public.update_referral_verifications(
    distribution_id INTEGER,
    shares distribution_shares[]
)
...
-- Update tag_referral weights - check if in shares and amount > 0
UPDATE distribution_verifications dv
SET weight = CASE
    WHEN ts.user_id IS NOT NULL AND ts.amount > 0 THEN 1
    ELSE 0
END
...
```

Key qualification criteria:
- Referred user must have a `distribution_share` record
- Share `amount` must be greater than 0
- Uses current distribution shares (recalculated during distribution processing)

### Initial Seeding vs. Recalculation

Two functions handle referral verifications:

1. **`insert_tag_referral_verifications(distribution_num)`** - Seeds initial `tag_referral` records at distribution creation, using previous distribution shares
2. **`update_referral_verifications(distribution_id, shares)`** - Recalculates weights during share calculation using current shares

The `update_referral_verifications` function is the authoritative source during final distribution calculation.

### Weight Calculation

For `total_tag_referrals`, the weight equals the count of qualified referrals:

```sql
-- From insert_total_referral_verifications
SELECT
  COUNT(*) FILTER (WHERE EXISTS (
    SELECT 1
    FROM distribution_shares ds
    WHERE ds.user_id = r.referred_id
    AND ds.distribution_id = prev_dist_id
    AND ds.amount > 0
  )) AS qualified_referrals
FROM referrals r
```

## Multiplier Calculation (Distributor V2)

The distributor calculates multipliers in `apps/distributor/src/distributorv2.ts`:

```typescript
interface Multiplier {
  value: number | undefined
  min: number
  max: number
  step: number
}

// For each verification with multiplier config
if (weight === 1) {
  // Single qualification: start at min
  if (multiplierInfo.value === undefined) {
    multiplierInfo.value = multiplierInfo.min
  } else if (multiplierInfo.value < multiplierInfo.max) {
    // Additional qualifications: increment by step
    multiplierInfo.value = Math.min(
      multiplierInfo.value + multiplierInfo.step,
      multiplierInfo.max
    )
  }
} else {
  // Weight-based: min + (weight - 1) * step
  multiplierInfo.value = Math.min(
    multiplierInfo.min + (weight - 1) * multiplierInfo.step,
    multiplierInfo.max
  )
}

// Final multiplier: product of all type multipliers
const finalMultiplier = Object.values(multipliers).reduce(
  (acc, info) => acc * (info.value ?? 1.0),
  1.0
)
```

### Multiplier Behavior

For `tag_referral` (monthly, weight=1 per referral):
- First referral: `1.1`
- Second referral: `min(1.1 + 0.1, 2.0) = 1.2`
- Tenth referral: `min(1.1 + 0.1*9, 2.0) = 2.0` (capped)

For `total_tag_referrals` (cumulative, weight=count):
- 1 referral: `min(1.02 + 0*0.02, 2.0) = 1.02`
- 10 referrals: `min(1.02 + 9*0.02, 2.0) = 1.20`
- 50 referrals: `min(1.02 + 49*0.02, 2.0) = 2.00` (capped)

### Multiplicative Stacking

All multipliers apply multiplicatively:

```typescript
userFixedAmount = baseFixedAmount * finalMultiplier
// where finalMultiplier = tag_referral_mult * total_tag_referrals_mult * send_streak_mult * ...
```

## Key Files

| File | Purpose |
|------|---------|
| `apps/distributor/src/distributorv2.ts` | Distribution calculation logic |
| `supabase/schemas/distributions.sql` | Schema and functions for distributions |
| `supabase/schemas/referrals.sql` | Referral relationship schema |
| `supabase/migrations/20250401044154_insert_distribution_fourteen.sql` | Distribution 14 with referral multiplier values |
| `supabase/migrations/20250502220725_create_functions_for_distribution_inserts.sql` | Reusable insert functions |
| `packages/app/features/rewards/activity/screen.tsx` | Rewards UI |

## Testing

Referral verification logic is tested in:
- `apps/distributor/src/distributorv2.test.ts` - Distribution calculation tests
- `supabase/tests/` - pgTAP database function tests

## Notes

1. **UI Display**: The UI uses `weight` from `distribution_verifications` for `total_tag_referrals` display, not `metadata.value`
2. **Value Inheritance**: New distributions inherit multiplier values from the previous distribution via `insert_verification_value`
3. **Recalculation**: Referral weights are recalculated during each distribution run to reflect current share states
